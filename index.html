<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Coffee Shaky</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;padding:0;direction:rtl;background:#fdf6f0;font-family:sans-serif;color:#4e342e}
.container{max-width:800px;margin:30px auto;background:#fff;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.1);padding:30px}
h1{text-align:center;color:#6f4e37;margin-top:0}
.coffee-options{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin:25px 0}
.coffee-card{background:#faf3ee;border:2px solid transparent;border-radius:10px;width:150px;text-align:center;cursor:pointer;padding:15px;transition:.3s}
.coffee-card:hover{transform:translateY(-5px)}
.coffee-card.selected{border-color:#6f4e37}
.coffee-icon img{width:55px;height:55px;display:block;margin:0 auto 8px}
.form-group{margin-bottom:15px}
input,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:1em}
textarea{resize:vertical;min-height:60px}
button{padding:12px;background:#6f4e37;color:#fff;border:none;border-radius:6px;font-size:1.1em;cursor:pointer;width:100%}
button:hover{background:#5a3e2b}
ul{list-style:none;padding:0;margin:15px 0 0}
li{display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid #eee}
li.completed{text-decoration:line-through;color:#999}
.order-info{flex:1}
.order-check{margin-left:10px;width:20px;height:20px;cursor:pointer}
.admin-btn{margin:5px;padding:6px 12px;border:none;border-radius:6px;background:#b71c1c;color:#fff;cursor:pointer}
</style>
</head>
<body>
<div class="container">
  <h1>Coffee Shaky â˜•</h1>

  <!-- ×‘×—×™×¨×ª ××©×§×” -->
  <div class="coffee-options">
    <div class="coffee-card" data-coffee="Espresso">
      <div class="coffee-icon"><img src="espresso.png" alt="Espresso"></div>××¡×¤×¨×¡×•
    </div>
    <div class="coffee-card" data-coffee="Macchiato">
      <div class="coffee-icon"><img src="macchiato.png" alt="Macchiato"></div>××§×™××˜×•
    </div>
    <div class="coffee-card" data-coffee="Cappuccino">
      <div class="coffee-icon"><img src="cappuccino.png" alt="Cappuccino"></div>×§×¤×•×¦'×™× ×•
    </div>
    <div class="coffee-card" data-coffee="Americano">
      <div class="coffee-icon"><img src="americano.png" alt="Americano"></div>×××¨×™×§× ×•
    </div>
    <div class="coffee-card" data-coffee="Tea">
      <div class="coffee-icon"><img src="tea.png" alt="Tea"></div>×ª×”
    </div>
  </div>

  <!-- ×˜×•×¤×¡ -->
  <form id="orderForm">
    <div class="form-group">
      <label for="userName">×©×:</label>
      <input id="userName" required>
    </div>
    <div class="form-group">
      <label for="specialRequest">×‘×§×©×” ××™×•×—×“×ª (×œ× ×—×•×‘×”):</label>
      <textarea id="specialRequest"></textarea>
    </div>
    <button type="submit">×”×–××Ÿ ××©×§×”</button>
  </form>

  <!-- ×ª×•×¨ ×”×–×× ×•×ª -->
  <h2>×ª×•×¨ ×”×”×–×× ×•×ª</h2>
  <button id="deleteAll" class="admin-btn">ğŸ—‘ï¸ ××—×§ ××ª ×›×œ ×”×”×–×× ×•×ª</button>
  <ul id="orderQueue"><li>×˜×•×¢×Ÿâ€¦</li></ul>
</div>

<script type="module">
/* ---- 1. ×—×™×‘×•×¨ ×œ-Supabase ---- */
const supabase = supabase.createClient(
  "https://txnorybrbgmwzoibrode.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6Ikp..."
);

/* ---- 2. DOM ---- */
const form        = document.getElementById("orderForm");
const orderQueue  = document.getElementById("orderQueue");
const deleteAll   = document.getElementById("deleteAll");
const cards       = document.querySelectorAll(".coffee-card");
let   selectedCoffee = null;

/* ---- 3. ×‘×—×™×¨×ª ××©×§×” ---- */
cards.forEach(card=>{
  card.addEventListener("click",()=>{
    cards.forEach(c=>c.classList.remove("selected"));
    card.classList.add("selected");
    selectedCoffee = card.dataset.coffee;
  });
});

/* ---- 4. ×©×œ×™×—×ª ×”×–×× ×” ---- */
form.addEventListener("submit", async e=>{
  e.preventDefault();
  const name = document.getElementById("userName").value.trim();
  const note = document.getElementById("specialRequest").value.trim();
  if(!name||!selectedCoffee){alert("×™×© ×œ×”×–×™×Ÿ ×©× ×•×œ×‘×—×•×¨ ××©×§×”");return;}

  const {error} = await supabase.from("orders")
    .insert([{name, beverage:selectedCoffee, special_request:note, status:"pending"}])
    .select();     // ××—×–×™×¨ ××ª ×”×©×•×¨×” ×©-INSERT-× ×• (×•××¤×¢×™×œ default timestamp)

  if(error){alert("×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×–×× ×”");console.error(error);return;}

  form.reset(); cards.forEach(c=>c.classList.remove("selected")); selectedCoffee=null;
  refresh();     // ×¨×™×¢× ×•×Ÿ ××™×™×“×™ (××¢×œRealtime ×œ×™×ª×¨ ×‘×˜×—×•×Ÿ)
});

/* ---- 5. ××—×™×§×ª ×”×›×œ (×§×•×“ ××•×¡×ª×¨) ---- */
deleteAll.addEventListener("click", async()=>{
  if(prompt("×§×•×“ ××—×™×§×”")!=="1707") return;
  const {error}=await supabase.from("orders").delete().neq("id",0);
  if(error) alert("×©×’×™××”"); else alert("×›×œ ×”×”×–×× ×•×ª × ××—×§×•");
});

/* ---- 6. ×¨×™× ×“×•×¨ ×ª×•×¨ ---- */
function render(list=[]){
  orderQueue.innerHTML="";
  if(!list.length){orderQueue.innerHTML="<li>××™×Ÿ ×”×–×× ×•×ª</li>";return;}
  list.forEach(o=>{
    const li=document.createElement("li");
    if(o.status==="completed") li.classList.add("completed");

    const info=document.createElement("span");
    info.className="order-info";
    const time=new Date(o.timestamp||Date.now())
      .toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"});
    info.textContent=`${time} â€“ ${o.name}: ${o.beverage}${
      o.special_request?` (×‘×§×©×”: ${o.special_request})`:""}`;
    li.appendChild(info);

    const cb=document.createElement("input");
    cb.type="checkbox"; cb.className="order-check";
    cb.checked=o.status==="completed";
    cb.addEventListener("change",()=>supabase.from("orders")
      .update({status:cb.checked?"completed":"pending"}).eq("id",o.id));
    li.appendChild(cb);

    orderQueue.appendChild(li);
  });
}

/* ---- 7. ×˜×¢×™× ×” ×¨××©×•× ×™×ª ---- */
async function refresh(){
  const {data,error}=await supabase.from("orders")
    .select("*").order("timestamp",{ascending:false});
  if(!error) render(data);
}
refresh();

/* ---- 8. Realtime ---- */
supabase.channel("orders_stream")
  .on("postgres_changes",{event:"*",schema:"public",table:"orders"},()=>refresh())
  .subscribe();
</script>
</body>
</html>
