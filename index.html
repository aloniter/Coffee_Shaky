<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Coffee Shaky</title>

  <link rel="icon" href="appicon.png">
  <link rel="apple-touch-icon" href="appicon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6f4e37">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* (××•×ª×• CSS ×‘×“×™×•×§, ×§×™×¦×¨×ª×™ ×›××Ÿ ×œ×¦×•×¨×š ×”×“×•×’××”) */
    .coffee-card.selected{border-color:#6f4e37}
    .coffee-icon img{width:100%;height:100%;object-fit:contain}
    [data-coffee="××¡×¤×¨×¡×•"] .coffee-icon img{transform:scale(1.25);margin-top:-3px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Coffee Shaky â˜•</h1>

    <div class="coffee-options">
      <!-- ... ×”×›×¨×˜×™×¡×™× ... -->
    </div>

    <form id="orderForm" autocomplete="off">
      <!-- ... -->
    </form>

    <button id="deleteAll" class="admin-btn">ğŸ—‘ï¸ ××—×§ ××ª ×›×œ ×”×”×–×× ×•×ª</button>
    <h2>×ª×•×¨ ×”×”×–×× ×•×ª</h2>
    <ul id="orderQueue"><li>×˜×•×¢×Ÿâ€¦</li></ul>
  </div>

  <script type="module">
  /* Supabase */
  const sb = supabase.createClient(
    "https://txnorybrbgmwzoibrode.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  );

  /* DOM refs */
  const cards=document.querySelectorAll(".coffee-card");
  const form=document.getElementById("orderForm");
  const list=document.getElementById("orderQueue");
  const status=document.getElementById("formStatus");
  const delBtn=document.getElementById("deleteAll");
  let selected=null;

  /* ×‘×—×™×¨×ª ××©×§×” */
  cards.forEach(c=>c.onclick=()=>{
    cards.forEach(x=>x.classList.remove("selected"));
    c.classList.add("selected");
    selected=c.dataset.coffee;
  });

  /* ×©×œ×™×—×ª ×”×–×× ×” */
  form.addEventListener("submit",async e=>{
    e.preventDefault();
    status.textContent="";
    const name=document.getElementById("userName").value.trim();
    const note=document.getElementById("specialRequest").value.trim();
    if(!name||!selected){status.textContent="×™×© ×œ×”×–×™×Ÿ ×©× ×•×œ×‘×—×•×¨ ××©×§×”";return;}

    const {error}=await sb.from("orders").insert({name,beverage:selected,special_request:note,status:"pending"});
    if(error){status.textContent="âŒ ×©×’×™××”";console.error(error);}
    else{
      status.textContent="âœ… ×”×”×–×× ×” × ×§×œ×˜×”!";
      form.reset();cards.forEach(x=>x.classList.remove("selected"));selected=null;
      refresh(); // ×¨×¢× ×Ÿ ××™×“
    }
  });

  /* ××—×™×§×” */
  delBtn.onclick=async()=>{
    if(prompt("×§×•×“ ××—×™×§×”")!=="1707")return;
    await sb.from("orders").delete().neq("id",0);
    refresh();
  };

  /* ×¨×™× ×“×•×¨ */
  function render(arr){
    list.innerHTML=arr.length?"":"<li>××™×Ÿ ×”×–×× ×•×ª</li>";
    arr.forEach(o=>{
      const li=document.createElement("li");
      if(o.status==="completed")li.classList.add("completed");
      li.innerHTML=`
        <span class="order-info">
          ${new Date(o.created_at||Date.now()).toLocaleTimeString("he-IL",{hour:'2-digit',minute:'2-digit'})}
          â€“ ${o.name}: ${o.beverage}${o.special_request?` (×‘×§×©×”: ${o.special_request})`:""}
        </span>
        <input type="checkbox" class="order-check" ${o.status==="completed"?"checked":""}>
      `;
      li.querySelector(".order-check").onchange=e=>{
        sb.from("orders").update({status:e.target.checked?"completed":"pending"}).eq("id",o.id);
      };
      list.appendChild(li);
    });
  }

  async function refresh(){
    const {data}=await sb.from("orders").select("*").order("id",{ascending:false});
    render(data||[]);
  }
  refresh();
  sb.channel("orders_stream").on("postgres_changes",{event:"*",schema:"public",table:"orders"},refresh).subscribe();

  /* ×¨×™×©×•× Service Worker */
  if ('serviceWorker' in navigator){
    navigator.serviceWorker.register("./service-worker.js")
      .then(reg=>reg.update())
      .catch(err=>console.error("SW error",err));
  }
  </script>
</body>
</html>
